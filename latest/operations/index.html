<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://sequenceiq.com/cloudbreak-deployer/operations/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Operations - Cloudbreak</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" background="red">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <img class="navbar-logo" src="http://docs.hortonworks.com/HDPDocuments/Ambari-2.1.0.0/bk_Installing_HDP_AMB/common/images/hortonworks-logo.png" alt="Hortonworks Documentation" width="132" height="52">
            <a class="navbar-brand" href="..">Cloudbreak</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="..">Introduction</a>
</li>

                        
                            
<li >
    <a href="../architecture/">Architecture</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Installation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../onprem/">Cloudbreak Deployer</a>
</li>

        
            
<li >
    <a href="../aws-image/">AWS Cloud Images</a>
</li>

        
            
<li >
    <a href="../gcp-image/">GCP Cloud Images</a>
</li>

        
            
<li >
    <a href="../openstack-image/">OpenStack Cloud Images</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../releasenotes/">Release Notes</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cloud Providers <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">AWS</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../aws/">Setup</a>
</li>

        
            
<li >
    <a href="../aws_pre_prov/">Provisioning Prerequisites</a>
</li>

        
            
<li >
    <a href="../aws_cb_ui/">Provisioning - UI</a>
</li>

        
            
<li >
    <a href="../aws_cb_shell/">Provisioning - CLI</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Azure</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../azure/">Setup</a>
</li>

        
            
<li >
    <a href="../azure_pre_prov/">Provisioning Prerequisites</a>
</li>

        
            
<li >
    <a href="../azure_cb_ui/">Provisioning - UI</a>
</li>

        
            
<li >
    <a href="../azure_cb_shell/">Provisioning - CLI</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">GCP</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../gcp/">Setup</a>
</li>

        
            
<li >
    <a href="../gcp_pre_prov/">Provisioning Prerequisites</a>
</li>

        
            
<li >
    <a href="../gcp_cb_ui/">Provisioning - UI</a>
</li>

        
            
<li >
    <a href="../gcp_cb_shell/">Provisioning - CLI</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">OpenStack</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../openstack/">Setup</a>
</li>

        
            
<li >
    <a href="../openstack_pre_prov/">Provisioning Prerequisites</a>
</li>

        
            
<li >
    <a href="../openstack_cb_ui/">Provisioning - UI</a>
</li>

        
            
<li >
    <a href="../openstack_cb_shell/">Provisioning - CLI</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/">API</a>
</li>

                        
                            
<li >
    <a href="../shell/">CLI/Shell</a>
</li>

                        
                            
<li >
    <a href="../periscope/">Auto-Scaling</a>
</li>

                        
                            
<li >
    <a href="../recipes/">Recipes</a>
</li>

                        
                            
<li >
    <a href="../blueprints/">Blueprints</a>
</li>

                        
                            
<li >
    <a href="../kerberos/">Kerberos</a>
</li>

                        
                            
<li >
    <a href="../spi/">SPI</a>
</li>

                        
                            
<li class="active">
    <a href="./">Operations</a>
</li>

                        
                            
<li >
    <a href="../database/">Migration</a>
</li>

                        
                            
<li >
    <a href="../configuration/">Advanced Configuration</a>
</li>

                        
                            
<li >
    <a href="../development/">Development</a>
</li>

                        
                            
<li >
    <a href="../changelog/">Changelog</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Versions <b class="caret"></b></a>
                    <ul class="dropdown-menu" id="versions-dropdown">
                    </ul>
                </li>
                
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../spi/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../database/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#operations">Operations</a></li>
        
            <li><a href="#cloudbreak-deployer">Cloudbreak deployer</a></li>
        
            <li><a href="#cloudbreak-application">Cloudbreak application</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="operations">Operations</h1>
<h2 id="cloudbreak-deployer">Cloudbreak deployer</h2>
<h3 id="debug">Debug</h3>
<p>If you want to have more detailed output set the <code>DEBUG</code> env variable to non-zero:</p>
<pre><code>DEBUG=1 cbd some_command
</code></pre>

<h3 id="troubleshoot">Troubleshoot</h3>
<p>You can use the <code>doctor</code> command to diagnose your environment.
It can reveal some common problems with your docker or boot2docker configuration and it also checks the cbd versions.</p>
<pre><code>cbd doctor
</code></pre>

<h3 id="logs">Logs</h3>
<p>The aggregated logs of all the Cloudbreak components can be checked with:</p>
<pre><code>cbd logs
</code></pre>

<p>It can also be used to check the logs of an individual docker container. To see only the logs of the Cloudbreak backend:</p>
<pre><code>cbd logs cloudbreak
</code></pre>

<p>You can also check the individual logs of <code>uluwatu</code>, <code>periscope</code>, and <code>identity</code>.</p>
<h3 id="update">Update</h3>
<p>The cloudbreak-deployer tool is capable of upgrading itself to a newer version.</p>
<pre><code>cbd update
</code></pre>

<h2 id="cloudbreak-application">Cloudbreak application</h2>
<h3 id="ssh-to-the-hosts">SSH to the hosts</h3>
<p>In the current version of Cloudbreak all the nodes have a public IP address and all the nodes are accessible via SSH.
The public IP addresses of a running cluster can be checked on the Cloudbreak UI under the <em>Nodes</em> tab.
Only key-based authentication is supported - the public key can be specified when creating a cloud credential.</p>
<pre><code>ssh -i ~/.ssh/private-key.pem cloudbreak@&lt;public-ip&gt;
</code></pre>

<p>The default user is <code>cloudbreak</code> except on EC2 where it is <code>ec2-user</code>.</p>
<h3 id="accessing-hdp-client-services">Accessing HDP client services</h3>
<p>The main difference between general HDP clusters and Cloudbreak-installed HDP clusters is that each host runs an Ambari server or agent Docker container and the HDP services will be installed in this container as well.
It means that after <code>ssh</code> the client services won't be available instantly, first you'll have to <code>enter</code> the ambari-agent container.
Inside the container everything works the same way as expected. In order to do so there are a few options.</p>
<p><em>Helper functions</em></p>
<p>We have created a few helper functions in order to help operations. Once yoy SSH into the host you should a message as such:</p>
<pre><code>You are now logged in to the docker host ...
Getting started with docker:

  docker ps                : Listing running containers
  docker logs -f &lt;ID&gt;      : Star tail -f on container stdout/stderr
  docker exec -it &lt;ID&gt; sh  : Entering the container (instead of ssh)

Helper commands:

  h                        : prints this message
  ambari-enter             : Enters the ambari container
  ambari-log               : Watches the ambari logs
</code></pre>

<p>You can enter into the container where the HDP services are running using the <code>ambari-enter</code> functions.</p>
<p><em>Docker exec</em></p>
<p>To check the containers running on the host enter:</p>
<pre><code>[cloudbreak@vmhostgroupclient11 ~]$ sudo docker ps
CONTAINER ID   IMAGE                                    COMMAND                CREATED      STATUS      PORTS     NAMES
1098ca778176   sequenceiq/baywatch-client:v1.0.0        &quot;/etc/bootstrap.sh -d&quot; 4 hours ago  Up 4 hours            baywatch-client-14454170059514
f4097c52fda5   sequenceiq/logrotate:v0.5.1              &quot;/start.sh&quot;            4 hours ago  Up 4 hours            logrotate-14454169954830
7b94aedaab30   sequenceiq/docker-consul-watch-plugn:1.0 &quot;/start.sh consul://1&quot; 4 hours ago  Up 4 hours            consul-watch-14454169884044
d8128b001427   sequenceiq/ambari:2.1.2-v2               &quot;/start-agent&quot;         4 hours ago  Up 4 hours            ambari-agent-14454169805924
a8ec90037aaf   swarm:0.4.0                              &quot;/swarm join --addr=1&quot; 4 hours ago  Up 4 hours  2375/tcp  vmhostgroupmaster12-swarm-agent
ef02b43eacee   sequenceiq/consul:v0.5.0-v5              &quot;/bin/start&quot;           4 hours ago  Up 4 hours            vmhostgroupmaster12-consul
</code></pre>

<p>You should see the <code>ambari-agent</code> container running. Copy its id or name and <code>exec</code> into the container:</p>
<pre><code>[cloudbreak@vmhostgroupclient11 ~]$ sudo docker exec -it ambari-agent-14454169805924 bash
[root@docker-ambari tmp]#
</code></pre>

<p>Or you can use this one-step command as well:</p>
<pre><code>[cloudbreak@vmhostgroupclient11 ~]$ sudo docker exec -it $(sudo docker ps -f=name=ambari-agent -q) bash
[root@docker-ambari tmp]#
</code></pre>

<h3 id="data-volumes">Data volumes</h3>
<p>The disks that are attached to the instances are automatically mounted to <code>/hadoopfs/fs1</code>, <code>/hadoopfs/fs2</code>, ... <code>/hadoopfs/fsN</code> respectively.
These directories are mounted from the host into the ambari-agent container under the same name so these can be accessed from inside.
It means that if you'd like to move some data to the instances you can use these volumes and the data will be available from the container instantly to work on it.</p>
<p>An <code>scp</code> Example:</p>
<pre><code>$ scp -qr -i ~/.ssh/private-key.pem ~/tmp/data cloudbreak@&lt;client-node&gt;:/hadoopfs/fs1
$ ssh -i ~/.ssh/private-key.pem cloudbreak@&lt;client-node&gt;
[cloudbreak@vmhostgroupclient11 ~]$ sudo docker exec -it $(sudo docker ps -f=name=ambari-agent -q) bash
[root@docker-ambari tmp]# su hdfs
[hdfs@docker-ambari tmp]# hadoop fs -put /hadoopfs/fs1/data /tmp
[hdfs@docker-ambari tmp]# hadoop fs -ls /tmp
Found 2 items
drwxr-xr-x   - hdfs supergroup          0 2015-10-21 13:46 /tmp/data
drwx-wx-wx   - hive supergroup          0 2015-10-21 08:51 /tmp/hive
</code></pre>

<h3 id="internal-hostnames">Internal hostnames</h3>
<p>After a cluster is created with Cloudbreak, the nodes will have internal hostnames like this:</p>
<p><code>vmhostgroupclient11.node.dc1.consul</code></p>
<p>This is because Cloudbreak uses <a href="https://www.consul.io">Consul</a> to provide DNS services.
It means that you won't see entries to the other nodes inside the <code>/etc/hosts</code> file, because nodes are registered inside Consul and the hostnames are resolved by Consul as well.</p>
<p>In the current version the <code>node.dc1.consul</code> domain is hardcoded and cannot be changed.</p>
<h3 id="accessing-ambari-server-from-the-other-nodes">Accessing Ambari server from the other nodes</h3>
<p>Ambari server is registered as a service in Consul, so it can always be accessed through its domain name <code>ambari-8080.service.consul</code> from the other ambari containers.
It can be tried by pinging it from one of the <code>ambari-agent</code> containers:</p>
<pre><code>ping ambari-8080.service.consul
</code></pre>

<h3 id="cloudbreak-gateway-node">Cloudbreak gateway node</h3>
<p>With every Cloudbreak cluster installation there is a special node called <em>cbgateway</em> started that won't run an ambari-agent container so it won't run HDP services either.
It can be seen on the Cloudbreak UI among the hostgroups when creating a cluster, but its node count cannot be changed from 1 and it shouldn't be there in the Ambari blueprint.
It is by design because this instance has some special tasks:</p>
<ul>
<li>it runs the Ambari server and its database inside Docker containers</li>
<li>it runs an nginx proxy that is used by the Cloudbreak API to communicate with the cluster securely</li>
<li>it runs the Swarm manager that orchestrates the Docker containers on the whole cluster</li>
<li>it runs the Baywatch server that is responsible for collecting the operational logs from the cluster</li>
<li>it runs a Kerberos KDC container if Kerberos is configured</li>
</ul>
<p><strong>Logs</strong></p>
<p><em>Hadoop logs</em></p>
<p>Hadoop logs are available from the host and from the container as well in the <code>/hadoopfs/fs1/logs</code> directory.</p>
<p><em>Ambari logs</em></p>
<p>For Ambari logs you can use our helper function, <code>ambari-log</code>. For further information please check the <em>Helper functions</em> section. Alternatively you watch the Ambari logs on the host instance as well under the <code>`/hadoopfs/fs1/logs</code> folder as well.</p>
<p><strong>Ambari database</strong></p>
<p>Ambari's database runs on the <code>cbgateway</code> node inside a PostgreSQL docker container. To access it SSH to the <code>gateway</code> node and run the following command:</p>
<pre><code>[cloudbreak@vmcbgateway0 ~]$ sudo docker exec -it ambari_db psql -U postgres
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="https://gliderlabs.com/pagebuilder">Pagebuilder</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

         <script>
           $( document ).ready(function() {
               $.getJSON("http://sequenceiq.com/cloudbreak-deployer/versions.json", function(data) {
               $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-deployer/latest">latest ('+data.latest+')</a></li>');
                $.each(data.versions, function( index, value ) {
                  $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-deployer/'+value+'">'+value+'</a></li>');
                });
               });

               <!--AWS Table-->
               $.getJSON("../providers/aws.json", function(data) {
               $("#aws-image-details").append('<br>');
               $("#aws-image-details").append('<br>');
               $("#aws-image-details").append('<table>');
                 $("#aws-image-details").append('<col width="290">');
                 $("#aws-image-details").append('<col width="290">');
                 $("#aws-image-details").append('<thead>');
                  $("#aws-image-details").append('<tr>');
                   $("#aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Region" + '</th>');
                   $("#aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Image Name" + '</th>');
                  $("#aws-image-details").append('</tr>');
                 $("#aws-image-details").append('</thead>');
                $("#aws-image-details").append('<tbody>');
                 $.each(data.metadata, function( index, value ) {
                 if (index.indexOf("region.") === 0) {
                   shortIndex = index.substring(7)
                  $("#aws-image-details").append('<tr>');
                   $("#aws-image-details").append('<td halign="center" valign="center" text-align="left" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + shortIndex + '</td>');
                   $("#aws-image-details").append('<td halign="center" valign="center" text-align="right" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + value + '</td>');
                  $("#aws-image-details").append('</tr>');
                  }
                 });
                $("#aws-image-details").append('</tbody>');
               $("#aws-image-details").append('</table>');
               });

               <!--OpenStack-->
               $.getJSON("../providers/openstack.json", function(data) {
               $("#openstack-image-details").append('<br>');
               $("#openstack-image-details").append('<br>');
               $("#openstack-image-details").append('<p style="font-size: 12pt"><code>LATEST_IMAGE:</code>' + data.id + '</p>');
               $("#openstack-image-details").append('<pre><code style="font-size: 12pt;color:#333333">curl -L  https://atlas.hashicorp.com/api/v1/artifacts/sequenceiq/cbd/openstack.image/' + data.version + '/file | tar -xz</code></pre>');
               });

               <!--GCP-->
               $.getJSON("../providers/gcp.json", function(data) {
               $("#gcp-image-details").append('<br>');
               $("#gcp-image-details").append('<br>');
               $("#gcp-image-details").append('<pre><code style="font-size: 12pt;color:#333333">gcloud compute images create ' + data.gcp.id + ' --source-uri gs://' + data.gcp.source_image + '</code></pre>');
               });
           });
         </script>
    </body>
</html>
